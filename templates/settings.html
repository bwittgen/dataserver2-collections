{% extends "base.html" %}

{% block title %}Settings - Dataserver2 Collections{% endblock %}

{% block content %}
{% if message %}
<div class="alert alert-success">{{ message }}</div>
{% endif %}

{% if error %}
<div class="alert alert-error">{{ error }}</div>
{% endif %}

<div class="card">
    <h2>Authentication Settings</h2>
    <form method="POST">
        <input type="hidden" name="action" value="update_auth">
        
        <div class="form-group">
            <label>
                <input type="checkbox" name="enable_auth" {% if config.authentication_enabled %}checked{% endif %}>
                Enable Forms Authentication
            </label>
            <p style="color: #888; font-size: 0.9rem; margin-top: 0.5rem;">
                When enabled, users must log in with username and password to access the application.
            </p>
        </div>
        
        <div class="form-group">
            <label for="username">Username</label>
            <input type="text" id="username" name="username" value="{{ config.username or '' }}" placeholder="Enter username">
        </div>
        
        <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" name="password" placeholder="Enter new password (leave empty to keep current)">
            <p style="color: #888; font-size: 0.9rem; margin-top: 0.5rem;">
                Leave empty to keep the current password unchanged.
            </p>
        </div>
        
        <button type="submit" class="btn btn-primary">Save Authentication Settings</button>
    </form>
</div>

<div class="card">
    <h2>API Key</h2>
    <p style="color: #b0b0b0; margin-bottom: 1rem;">
        API keys allow programmatic access to the application. Include the API key in the <code>X-Api-Key</code> header.
    </p>
    
    {% if config.api_key %}
    <div class="api-key-display">
        <strong>Current API Key:</strong><br>
        {{ config.api_key }}
    </div>
    
    <div style="display: flex; gap: 1rem;">
        <form method="POST" style="display: inline;">
            <input type="hidden" name="action" value="generate_api_key">
            <button type="submit" class="btn btn-secondary">Regenerate API Key</button>
        </form>
        
        <form method="POST" style="display: inline;">
            <input type="hidden" name="action" value="delete_api_key">
            <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete the API key?')">Delete API Key</button>
        </form>
    </div>
    {% else %}
    <p style="color: #888; margin-bottom: 1rem;">No API key configured.</p>
    <form method="POST">
        <input type="hidden" name="action" value="generate_api_key">
        <button type="submit" class="btn btn-primary">Generate API Key</button>
    </form>
    {% endif %}
</div>

<div class="card">
    <h2>Kometa Configuration</h2>
    <p style="color: #b0b0b0; margin-bottom: 1rem;">
        Configure the path to your Kometa configuration directory to view and manage collection files.
    </p>
    <form method="POST">
        <input type="hidden" name="action" value="update_kometa">
        
        <div class="form-group">
            <label for="kometa_config_path">Kometa Config Directory Path</label>
            <input type="text" id="kometa_config_path" name="kometa_config_path" 
                   value="{{ config.kometa_config_path or '' }}" 
                   placeholder="/path/to/kometa/config">
            <p style="color: #888; font-size: 0.9rem; margin-top: 0.5rem;">
                Path to the Kometa configuration directory containing your collection YML files.
            </p>
        </div>
        
        <button type="submit" class="btn btn-primary">Save Kometa Configuration</button>
    </form>
</div>

<div class="card">
    <h2>Media Services</h2>
    <p style="color: #b0b0b0; margin-bottom: 1rem;">
        Configure URLs and API keys for your media management services. These will appear in the sidebar navigation.
    </p>
    <form method="POST">
        <input type="hidden" name="action" value="update_services">
        
        <h3 style="color: #4a9eff; font-size: 1.2rem; margin-bottom: 1rem;">Sonarr</h3>
        <div class="form-group">
            <label for="sonarr_url">URL</label>
            <input type="text" id="sonarr_url" name="sonarr_url" 
                   value="{{ config.services.sonarr.url if config.services and config.services.sonarr else 'http://dataserver2:8989' }}" 
                   placeholder="http://dataserver2:8989">
        </div>
        <div class="form-group">
            <label for="sonarr_api_key">API Key</label>
            <input type="text" id="sonarr_api_key" name="sonarr_api_key" 
                   value="{{ config.services.sonarr.api_key if config.services and config.services.sonarr else '' }}" 
                   placeholder="Enter Sonarr API Key">
        </div>
        
        <h3 style="color: #4a9eff; font-size: 1.2rem; margin-bottom: 1rem; margin-top: 2rem;">Radarr</h3>
        <div class="form-group">
            <label for="radarr_url">URL</label>
            <input type="text" id="radarr_url" name="radarr_url" 
                   value="{{ config.services.radarr.url if config.services and config.services.radarr else 'http://dataserver2:7878' }}" 
                   placeholder="http://dataserver2:7878">
        </div>
        <div class="form-group">
            <label for="radarr_api_key">API Key</label>
            <input type="text" id="radarr_api_key" name="radarr_api_key" 
                   value="{{ config.services.radarr.api_key if config.services and config.services.radarr else '' }}" 
                   placeholder="Enter Radarr API Key">
        </div>
        
        <h3 style="color: #4a9eff; font-size: 1.2rem; margin-bottom: 1rem; margin-top: 2rem;">Bazarr</h3>
        <div class="form-group">
            <label for="bazarr_url">URL</label>
            <input type="text" id="bazarr_url" name="bazarr_url" 
                   value="{{ config.services.bazarr.url if config.services and config.services.bazarr else 'http://dataserver2:6767' }}" 
                   placeholder="http://dataserver2:6767">
        </div>
        <div class="form-group">
            <label for="bazarr_api_key">API Key</label>
            <input type="text" id="bazarr_api_key" name="bazarr_api_key" 
                   value="{{ config.services.bazarr.api_key if config.services and config.services.bazarr else '' }}" 
                   placeholder="Enter Bazarr API Key">
        </div>
        
        <h3 style="color: #4a9eff; font-size: 1.2rem; margin-bottom: 1rem; margin-top: 2rem;">Whisparr</h3>
        <div class="form-group">
            <label for="whisparr_url">URL</label>
            <input type="text" id="whisparr_url" name="whisparr_url" 
                   value="{{ config.services.whisparr.url if config.services and config.services.whisparr else 'http://dataserver2:6969' }}" 
                   placeholder="http://dataserver2:6969">
        </div>
        <div class="form-group">
            <label for="whisparr_api_key">API Key</label>
            <input type="text" id="whisparr_api_key" name="whisparr_api_key" 
                   value="{{ config.services.whisparr.api_key if config.services and config.services.whisparr else '' }}" 
                   placeholder="Enter Whisparr API Key">
        </div>
        
        <button type="submit" class="btn btn-primary">Save Service Configurations</button>
    </form>
</div>

<div class="card">
    <h2>About</h2>
    <p style="color: #b0b0b0;">
        This web application provides authentication and management features for Dataserver2 Collections.
    </p>
    <ul style="margin-left: 2rem; margin-top: 1rem; color: #b0b0b0;">
        <li>Forms-based authentication similar to Sonarr/Radarr</li>
        <li>API key support for programmatic access</li>
        <li>Live log viewing</li>
        <li>Collection management</li>
        <li>Media service quick links</li>
    </ul>
</div>
{% endblock %}
